// lonely-sword.c ¾Ž
// Last Modified by sir 10.22.2001

#include <ansi.h>
#include <combat.h>
inherit SKILL;
string type() { return "martial"; }
string martialtype() { return "skill"; }
int action_po(object me, object victim, object weapon, int damage);
int action_busy(object me, object victim, object weapon, int damage);
int action_damage(object me, object victim, object weapon, int damage);
int action_parry(object me, object victim, object weapon, int damage);
int action_dodge(object me, object victim, object weapon, int damage);
int action_spbusy(object me, object victim, object weapon, int damage);
int action_spdamage(object me, object victim, object weapon, int damage);
int action_spparry(object me, object victim, object weapon, int damage);
int action_spdodge(object me, object victim, object weapon, int damage);

string *order = ({""HIY"", ""HIG"", ""RED"", ""MAG"", ""YEL"", ""HIC"", ""HIW"", ""HIR"",""HIB"", ""CYN"",""WHT"",""HIM"",""BLU""});

string *parry_msg = ({
	"ȴ$n̤ǰһʽбָұۣҪʹ$Pˡ\n",
	"$nԹΪأԽΪˣ$P͹ػӳλ̩ɽ"+(order[random(13)])+""NOR"\n",
	"$nͻ䣬ڽزʹɽ"+(order[random(13)])+""NOR"ͼʹ$PС\n",
	"$nͻȻһ$P$lһȴţ$P޴룬Ʋͣ\n"
	"$nܣٽʹ"+(order[random(13)])+"両ࡹ"NOR"$P$l뵲С\n",
	"$nͻȻʹɷ罣"+(order[random(13)])+"ڤڤ"NOR"Ƿλȴƫ$Pһʣ\nͼͻ$PĹƣ\n"
	"$nͦһ"+(order[random(13)])+"Ƴᶡ"NOR"ش$P$lͼ$PĹƻ⡣\n",
	"ֻ$n˷Ʈ磬һʽ"+(order[random(13)])+""NOR"޶׽صס$P\n\n",
	"$n˷ʹɽ"+(order[random(13)])+"롹"NOR"ɭɭܣܿ$P\n",
});

mapping *action = ({
([	"action" : "$Nͦϣ$wһһз·̩ɽ"+(order[random(13)])+"Ȫ"NOR"ֱ$n
$l",
	"lvl" : 0,
	"skill_name" : "Ȫ"
]),
([	"action" : "$N$nӳ"+(order[random(13)])+"Ȫܽء"NOR""+(order[random(13)])+"ϸǡ"NOR""+(order[random(13)])+"ʯ"NOR""+(order[random(13)])+"
"NOR""+(order[random(13)])+"ףڡ"NOR"ɽ񽣣",
	"lvl" : 10,
	"skill_name" : "ɽ"
]),
([
	"action" : "$Nת̳ʮŽȻǻɽ"+(order[random(13)])+"ŮʮŽ"NOR"
ʮŽһУַ֮죬ֱǷ˼",
	"lvl" : 20,
	"skill_name" : "ŮʮŽ"
]),
([	"action" : "$Nƺ裬ɽΪһ$n
ȥ",
	"lvl" : 30,
	"skill_name" : "ɽ"
]),
([	"action" : "$N$wһڣ$nԼ$wײ֮ʵѲ⣡",
	"lvl" : 40,
	"skill_name" : "֮"
]),
([	"action" : "$Nһ"+(order[random(13)])+"ɽ"NOR"$wն䣬ֱ$n
$l",
	"lvl" : 50,
	"skill_name" : "ɽ"
]),
([	"action" : "$NЦׯϣ$wӣ"+(order[random(13)])+"Ħ"NOR"Ϊһʽش
$n",
	"lvl" : 60,
	"skill_name" : "Ħ"
]),
([	"action" : "$Nأ$wҺɨЮ֮Ʊ$n"+(order[random(13)])+"Ħ
"NOR"Ľ¶ţ",
	"lvl" : 70,
	"skill_name" : "Ħ"
]),
([	"action" : "ȴ$NͻȻ鲽ʹ䵱"+(order[random(13)])+"ѵˮ"NOR"һУ",
	"lvl" : 80,
	"skill_name" : "ѵˮ"
]),
([	"action" : "$N˽磬з$n$lԱ$nأ"+(order[random(13)])+"
ħ"NOR""+(order[random(13)])+"ʽ"NOR"",
	"lvl" : 90,
	"skill_name" : "ʽ"
]),
([	"action" : "$Nת$nµ$n̳һ֪ʹʲ
ô",
	"lvl" : 100,
	"skill_name" : ""
]),
([	"action" : "$NЮƣ󿪴صҿһͨнԻ$nƵ
$nòأ",
	"lvl" : 110,
	"skill_name" : "󿪴"
]),
([	"action" : "$Nֺὣ$n$lеһȻ$n
Կ彣ƣ",
	"lvl" : 120,
	"skill_name" : ""
]),
([	"action" : "$NٽӣѸޱȵص$n$lȴ˿ʲô
ʽ",
	"lvl" : 130,
	"skill_name" : "ٽ"
]),
([	"action" : "$NͻȻ˽һֹ"+(order[random(13)])+"罣"NOR"Ȼ$nҴ
",
	"lvl" : 140,
	"skill_name" : "罣"
]),
([	"action" : "$Nߣһһ$nĪֲ$N
ʵ",
	"lvl" : 150,
	"post_action" : (: action_dodge :),
	"skill_name" : "Ī"
]),
([	"action" : "ȴ$N潣ߣһգұһ䣬ҲԽתԽӺ
"+(order[random(13)])+"̩ɽʮ̡"NOR"Ϊһ$n",
	"lvl" : 160,
	"post_action" : (: action_damage :),
	"skill_name" : "̩ɽʮ"
]),
([	"action" : "$NͻȻһ$n$lһȴţ$n޴룬֪
Ǻã",
	"post_action" : (: action_busy :),
	"lvl" : 170,
	"skill_name" : ""
]),
([	"action" : "$NͻЦݣƺѿ$n书ʽгһ$n
$l",
	"post_action" : (: action_parry :),
	"lvl" : 180,
	"skill_name" : "ͻЦ"
]),
([	"action" : "$N$wԽתԽ죬ʹľȻǺɽ"+(order[random(13)])+"ٱǧʮʽ"NOR"
ʽƾӿԹ߲ɵĿΪ֮ѣ",
	"lvl" : 190,
	"post_action" : (: action_spdodge :),
	"skill_name" : "ٱǧʮʽ"
]),
([	"action" : "$Nͻɭϣǧ۶ǹꪣɳǧ
ɽƻ$n$l",
	"lvl" : 200,
	"post_action" : (: action_spdamage :),
	"skill_name" : "ǹ"
]),
([	"action" : "$N$wʹ"+(order[random(13)])+"̫"NOR"⣬ССԲȦ޾
ԴԴز$n",
	"post_action" : (: action_spbusy :),
	"lvl" : 210,
	"skill_name" : "̫"
]),
([	"action" : "$Nͻ䣬ʹɽ"+(order[random(13)])+"һ㡹"NOR"$n$l֪
;ͻȻת򣬴$n֮⣡",
	"lvl" : 220,
	"post_action" : (: action_spparry :),
	"skill_name" : "һ"
]),
([	"action" : "$Nһָ$n$nڣ˵ף
˼飡",
	"post_action" : (: action_po :),
	"lvl" : 230,
	"skill_name" : ""
]),
});

int valid_enable(string usage) { return usage=="sword" || usage=="parry"; }
string query_parry_msg(string limb)
{
	return parry_msg[random(sizeof(parry_msg))];
}
int valid_learn(object me)
{
	object ob;

	mapping myfam;
	myfam = (mapping)me->query("family");
	if(!myfam || myfam["family_name"] != "ɽ"|| myfam["master_id"] != "feng qingyang")
		return notify_fail("¾Žֻǰѧϰ\n");
	if( (int)me->query("max_neili") < 600 )
		return notify_fail("ûа취¾Ž\n");
	if( (int)me->query_skill("zixia-shengong",1)<100)
		return notify_fail("¾Žϼ񹦲ϰ\n");
	if( !(ob = me->query_temp("weapon"))
	|| (string)ob->query("skill_type") != "sword" )
		return notify_fail("һѽ\n");
	if ((int)me->query_skill("lonely-sword",1) > 120)
		return notify_fail("׽Ҿͽ̵ԺҪԼˡ\n");

	return 1;
}
int practice_skill(object me)
{
	return notify_fail("¾Žֻܾͨʽ\n");
}
string query_skill_name(int level)
{
	int i;
	for(i = sizeof(action); i > 0; i--)
		if(level >= action[i-1]["lvl"])
			return action[i-1]["skill_name"];
}
mapping query_action(object me, object weapon)
{
/* d_e=dodge_effect p_e=parry_effect f_e=force_effect m_e=damage_effect */
	int d_e1 = -25;
	int d_e2 = -5;
	int p_e1 = -55;
	int p_e2 = -35;
	int f_e1 = 150;
	int f_e2 = 230;
	int m_e1 = 220;
	int m_e2 = 320;
	int i, lvl, seq, ttl = sizeof(action);

	lvl = (int) me->query_skill("lonely-sword", 1);
	for(i = ttl; i > 0; i--)
		if(lvl > action[i-1]["lvl"])
		{
			seq = i; /*  */
			break;
		}
	seq = random(seq);       /* ѡ */
	return ([
		"action"      : action[seq]["action"],
		"dodge"       : d_e1 + (d_e2 - d_e1) * seq / ttl,
		"parry"       : p_e1 + (p_e2 - p_e1) * seq / ttl,
		"post_action" : action[seq]["post_action"],
		"force"       : f_e1 + (f_e2 - f_e1) * seq / ttl,
		"damage"      : m_e1 + (m_e2 - m_e1) * seq / ttl,
		"damage_type" : random(2) ? "" : "",
	]);
}

int action_spbusy(object me, object victim, object weapon, int damage)
{
        int skill= me->query_skill("lonely-sword", 1);
        if( damage <= 0 && !victim->is_busy() 
            && me->query("neili") > 100
            && random(me->query("combat_exp")) > victim->query("combat_exp")/3 ) //С,û м
        {
         me->add("neili",-30);
         message_combatd("[1;37m$N[1;37mȻˡ, ಻֮, ˲䱬СС, бֱָԲȦ, $n[1;37mס[0m\n",me,victim);
         victim->start_busy(1+random(skill/50));
       	return 1;
        }
        return 1;
}

int action_spdamage(object me, object victim, object weapon, int damage)
{
        int skill= me->query_skill("lonely-sword", 1);

	      if( damage == RESULT_DODGE && !victim->is_busy()
	            && skill > 100
	            && me->query("neili") > 100
	            && random(skill) > victim->query_skill("force",1)/2 ) //
        {
        	me->add("neili",-30);
        	message_combatd("[1;37m$N[1;37mХ:Хɽӡ, ˲佣â,$n[1;37m[0m\n",me,victim);
          victim->receive_damage("qi",-skill*2);
          COMBAT_D->report_status(victim);
          return 1;
        }
        return 1;

}
int action_damage(object me, object victim, object weapon, int damage)
{
        int skill= me->query_skill("lonely-sword", 1);

        if (  damage > 0 && !victim->is_busy()
	            && skill > 100
	            && me->query("neili") > 100
	            && random(skill) > victim->query_skill("force",1)/4)   //жԷ
        {
        	me->add("neili",-30);
          message_combatd("[1;37m$N[1;37mͻȻ, , 项֮, гͻȻʧ, ѳ$n[1;37m[0m\n",me,victim);
          victim->receive_damage("qi",-skill);
          COMBAT_D->report_status(victim);
        	return 1;
        }
        return 1;

}
int action_spparry(object me, object victim, object weapon, int damage)
{
       string msg;
       if (damage == RESULT_DODGE &&
           random(me->query_skill("lonely-sword",1)) > 140 &&	
	         random(me->query_skill("sword",1))>140 &&
           me->query_skill("force",1) > 200 
           && !victim->is_busy())	
         {
        
           me->add("neili", -50);
           victim->map_skill("parry");
           if( !victim->is_busy() )
           {
             victim->start_busy(random(2)+1);
           }
           msg = HIC "$nٽش$N$Nһ" NOR;
           msg += HIY"$nԿ彣,Ȼмܣ\n"NOR;
           message_combatd(msg,victim,me);
        }
}

int action_spdodge(object me, object victim, object weapon, int damage)
{
	     string msg;
        if (random(me->query_skill("lonely-sword",1)) > 200 &&
            random(me->query_skill("sword",1))>180 &&
          	me->query_skill("force",1) > 250 
           	&& !victim->is_busy())
       {
          me->add("neili", -50);
          victim->map_skill("dodge");
         if( !victim->is_busy() )
         {
           victim->start_busy(random(3)+1);
         }
         msg = HIC "$nͻȻٽһ̣£ȴĪͻ$NĹƣ$Nϣ" ;
         msg += HIR"$nһȻܣ\n"NOR;
         message_combatd(msg,victim,me);
       }

}

int action_po(object me, object victim, object weapon, int damage)
{
	// ƶԷ书ڹ  ΪռЧ
	      int skill= me->query_skill("lonely-sword", 1);
        string v_force = victim->query_skill_mapped("force");
        int jiali;
	      if (damage > 0)// жԷ ڹ 
	      {
	      	if (v_force && skill > 250 
	      	   && skill/2 > random(victim->query("force")) && 
	      	   random(3)==1)
	      	{
	      		me->add("neili",-100);
	      		victim->map_skill("force");
            message_combatd(HIC "$Nһ֣ԴԴ$nס\n",me,victim);
            message_combatd(RED "$nֻѿأȻʩչ"+to_chinese(skill)+"\n" NOR,me,victim);
	        return 1;
	        }
	        else if (random(me->query_skill("lonely-sword",1)) > 100 &&
          random(me->query_skill("sword",1))>100 &&
         	me->query_skill("force",1) > 120
      	  && !victim->is_busy() )	
          {
          	me->add("neili",-50);
            if (victim->query("neili")>600)
               victim->add("neili", -500);
            else
               victim->set("neili",0);
          message_combatd(HIC "$Nһ֣ԴԴ$nס\n",me,victim);
          message_combatd(HIM "$nʹѳȦ\n"NOR, victim , me);
          return 1;
          }        
	      }
        else if( damage == RESULT_DODGE ) //  Է
        {
        	me->add("neili",-10);
        	message_combatd(HIY "$nֻ$Nаһӣҹǰȥ\n",me,victim);
          victim->start_busy(2);
        	return 1;
        }
        else if ( damage == RESULT_PARRY ) //мס ˳ٴ
        {
        	jiali = me->query("jiali");
          if (!jiali) jiali=10;
	        if( random(skill)>140 )
	        {
	        	me->add("neili",-50);
            message_combatd(HIC "$NཻһУѿ$n书·гִ̳һ!\n");
	          victim->receive_wound("qi", (random(jiali)+200));
	          message_combatd(HIM"$Nݺ! һ$n$lѪ!\n"NOR);
            COMBAT_D->report_status(victim,1);
           }
        	return 1;
        }
        return 1;
	
}

int learn_bonus() { return 0; }
int practice_bonus() { return 0; }
int success() { return 5; }
int power_point() { return 1.0; }

int valid_effect(object me, object weapon, string name, int skill)
{
}
string perform_action_file(string action)
{
	return __DIR__"lonely-sword/" + action;
}

int help(object me)
{
	write(HIC"\n¾Ž"NOR"\n");
	write(@HELP

    ¾Žнˣ
    ׽Ķǰֽܡ
һܶɵã⽣ʩչ޵У̽
޵£һƵһжɵãίʵ
ɾ塣
    ʤУǿҸǿ¾ŽʽмУ
С¾ŽҪּڡ򡹣ɾ಻ϵ
ȣʤͨ˾Ž⣬ʩɡ
    ¾ŽԡܾʽƽʽƵʽ
ǹʽƱʽʽʽƼʽ
ھŽʽŽĵһСܾʽֱ仯
ܾϰڶСƽʽƽ¸Ÿ
ɵĽСƵʽƽⵥ˫Ҷ
ͷ󿳵նֵСǹʽƽⳤ
ǹꪡìüˡȡֳ
֮СƱʽƽֱޡﵡѨӡ
ӡü̡ذס師ơ˽鳡׵ȵȶ̱У
Сʽƽǳޡڹǹ
ɴǵȵССʽƵȭָ
Ĺ򣬽ȭ̴õѨħצצɳƣȭ
ڡڰСƼʽ֣
һʱѧ֮Ҫһ
˷ְԵİ
˵СھŽʽΪԸϳڹĵ˶ã
֮һġ

	ѧϰҪ
		ֻѧϰ
		ϼ100
		600
HELP
	);
	return 1;
}

